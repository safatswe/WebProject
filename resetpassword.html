<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Reset Password | SUST Tutor</title>
  <link rel="stylesheet" href="bootstrap-5.3.3-dist/css/bootstrap.min.css">

  <style>
    body {
      background: linear-gradient(135deg, #0d1b2a, #1b263b);
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
    }
    .card {
      width: 420px;
      border-radius: 18px;
      background: #1e2a3a;
      padding: 30px;
      box-shadow: 0 0 15px rgba(0,0,0,0.4);
    }
    input {
      background: #0d1b2a !important;
      color: white !important;
    }
    .btn-custom {
      background: #fca311;
      font-weight: bold;
      border: none;
    }
    .btn-custom:hover {
      background: #f0a000;
    }
    a { color: #fca311; font-weight: bold; text-decoration: none; }
    a:hover { color: #ffb733; }
  </style>
</head>

<body>

  <div class="card">
    <h2 class="text-center text-warning mb-4">Reset Password</h2>

    <!-- STEP 1: Email -->
    <div id="step1">
      <label class="fw-bold">Enter your registered email</label>
      <input type="email" class="form-control mt-2" id="email">

      <button class="btn btn-custom w-100 mt-4" onclick="sendOTP()">Send OTP</button>
    </div>

    <!-- STEP 2: OTP + New Password -->
    <div id="step2" style="display:none;">
      <label class="fw-bold">Enter OTP</label>
      <input type="text" class="form-control mt-2" id="otp">

      <label class="fw-bold mt-3">New Password</label>
      <input type="password" class="form-control mt-2" id="newpass">

      <button class="btn btn-primary w-100 mt-4" onclick="resetPassword()">Reset Password</button>
    </div>

    <p class="text-center mt-3">
      <a href="login.html">Back to Login</a>
    </p>

    <div id="message" class="text-center mt-2 fw-bold"></div>
  </div>

  <script>
    // --------------------------
    // SEND OTP
    // --------------------------
    async function sendOTP() {
      const email = document.getElementById("email").value;
      const msg = document.getElementById("message");

      if (!email) {
        msg.innerHTML = "⚠ Enter email!";
        msg.style.color = "red";
        return;
      }

      const res = await fetch("/api/forgot-password", { // Correct backend route
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email })
      });

      const data = await res.json();

      if (data.success) {
        msg.innerHTML = " OTP sent to your email!";
        msg.style.color = "lightgreen";
        document.getElementById("step1").style.display = "none";
        document.getElementById("step2").style.display = "block";
      } else {
        msg.innerHTML = data.message;
        msg.style.color = "red";
      }
    }

    // --------------------------
    // RESET PASSWORD
    // --------------------------
    async function resetPassword() {
      const email = document.getElementById("email").value;
      const otp = document.getElementById("otp").value;
      const newpass = document.getElementById("newpass").value;
      const msg = document.getElementById("message");

      if (!otp || !newpass) {
        msg.innerHTML = "⚠ Enter OTP and new password!";
        msg.style.color = "red";
        return;
      }

      const res = await fetch("/api/reset-password", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, otp, new_password: newpass }) // match backend
      });

      const data = await res.json();

      if (data.success) {
        msg.innerHTML = " Password reset successful! Redirecting...";
        msg.style.color = "lightgreen";

        setTimeout(() => {
          window.location.href = "login.html";
        }, 1500);

      } else {
        msg.innerHTML = data.message;
        msg.style.color = "red";
      }
    }
  </script>

</body>
</html>

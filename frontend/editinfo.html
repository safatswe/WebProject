<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Edit Profile | SUST Tutor</title>
  <link rel="stylesheet" href="bootstrap-5.3.3-dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="style.css">
</head>
<body style="background-color: black;">
  <div class="edit-card border border-1 p-4 rounded-3 mb-5"
    style="width: 700px; margin: auto; margin-top: 90px; background-color: rgb(21, 23, 69);">
    <form id="editForm" class="mt-4 text-light p-2" style="width: 550px; margin: auto" enctype="multipart/form-data">
      <h3 class="p-2 w-50 rounded text-center text-light mt-2" style="background-color: rgb(4, 26, 58); margin: auto; box-shadow: 4px 4px 8px white;">Edit Your Info</h3>
      <div class="mt-3">
        <label class="form-label fw-semibold">Full Name</label>
        <input type="text" id="editName" name="full_name" class="form-control p-2" required>
      </div>
      <div class="mt-3">
        <label class="form-label fw-semibold">Email</label>
        <input type="email" id="editEmail" name="email" class="form-control p-2" required>
      </div>
      <div class="mt-3">
        <label class="form-label fw-semibold">Password</label>
        <input type="password" id="editPassword" name="password" class="form-control p-2"
          placeholder="Leave blank to keep current password">
      </div>
      <div class="mt-3">
        <label class="form-label fw-semibold">Address</label>
        <input type="text" id="editAddress" name="address" class="form-control p-2" required>
      </div>
      <div class="mt-3">
        <label class="form-label fw-semibold">Department</label>
        <input type="text" id="editDept" name="department" class="form-control p-2" required>
      </div>
      <div class="mt-3">
        <label class="form-label fw-semibold">Subject to Teach</label>
        <input type="text" id="editSubject" name="subject_to_teach" class="form-control p-2" required>
      </div>
      <div class="mt-3">
        <label class="form-label fw-semibold">Available</label>
        <input type="text" id="editAvailable" name="available" class="form-control p-2" placeholder="e.g., Yes/No">
      </div>
      <div class="mt-3">
        <label class="form-label fw-semibold">Available Time</label>
        <input type="text" id="editTime" name="available_time" class="form-control p-2" placeholder="e.g., Weekdays 6-9 PM">
      </div>
      <div class="mt-3">
        <label class="form-label fw-semibold">WhatsApp Number</label>
        <input type="text" id="editWhatsapp" name="whatsapp_number" class="form-control p-2" required>
      </div>
      <div class="mt-3">
        <label class="form-label fw-semibold">About Me</label>
        <textarea id="editAbout" name="about_me" class="form-control" rows="3"></textarea>
      </div>
      <div class="mt-4">
        <label class="form-label fw-semibold">Intro Video Link</label>
        <input type="text" id="editVideo" name="intro_video_link" class="form-control"
          placeholder="YouTube or other video link">
      </div>
      <div class="image-div bg-light p-2 rounded mt-4 ">
        <div class="text-dark">
          <label class="form-label fw-bold" style="color: black;">Profile Photo</label><br>
          <input type="file" id="editPhoto" name="photo" accept="image/*" style="width: 250px;">
          <img id="photoPreview" class="preview-img" src="https://via.placeholder.com/120" alt="Profile Preview">
        </div>
      </div>
      <div class="idphoto-div bg-light p-2 rounded mt-4">
        <div class="text-dark">
          <label class="form-label fw-semibold">Student ID Photo</label><br>
          <input type="file" id="editIdPhoto" name="id_photo" accept="image/*" style="width: 250px;">
          <img id="idPhotoPreview" class="preview-img" src="https://via.placeholder.com/120" alt="ID Preview">
        </div>
      </div>

      <div class="d-flex justify-content-around mt-5">
        <button type="submit" id="saveBtn" class="editProfile-btn p-2 rounded text-light"
          style="width:130px; background-color: rgb(106, 167, 14); ">Save Changes</button>
        <a href="myprofile.html" class="editProfile-btn text-center text-light p-2 rounded text-decoration-none"
          style="width:100px; background-color:darkgoldenrod">Cancel</a>
      </div>
    </form>

    <div class="text-center mt-4">
      <button id="deleteBtn" class="editProfile-btn p-2 rounded text-light"
        style="width:240px; background-color: tomato;">Delete Profile Permanently</button>
    </div>
  </div>
 <script>
  const apiBase = "/api";
  const user = JSON.parse(localStorage.getItem("loggedInUser"));

  if (!user) {
    alert("You must login first!");
    window.location.href = "/login.html";
  } else {
    // Pre-fill the form
    document.getElementById("editName").value = user.full_name || "";
    document.getElementById("editEmail").value = user.email || "";
    document.getElementById("editAddress").value = user.address || "";
    document.getElementById("editDept").value = user.department || "";
    document.getElementById("editSubject").value = user.subject_to_teach || "";
    document.getElementById("editWhatsapp").value = user.whatsapp_number || "";
    document.getElementById("editAbout").value = user.about_me || "";
    document.getElementById("editVideo").value = user.intro_video_link || "";
    document.getElementById("editTime").value = user.available_time || "";
    document.getElementById("editAvailable").value = user.available || "";

    // Show current photos
    document.getElementById("photoPreview").src = user.photo ? `/uploads/${user.photo}` : "https://via.placeholder.com/120";
    document.getElementById("idPhotoPreview").src = user.id_photo ? `/uploads/${user.id_photo}` : "https://via.placeholder.com/120";
  }

  // Preview uploaded images locally
  document.getElementById("editPhoto").onchange = e => {
    const [file] = e.target.files;
    if (file) document.getElementById("photoPreview").src = URL.createObjectURL(file);
  };
  document.getElementById("editIdPhoto").onchange = e => {
    const [file] = e.target.files;
    if (file) document.getElementById("idPhotoPreview").src = URL.createObjectURL(file);
  };

  // Save profile changes
  document.getElementById("editForm").onsubmit = async (e) => {
    e.preventDefault();
    if (!user || !user.id) {
      alert("User info missing. Please login again.");
      return window.location.href = "/login.html";
    }

    const formData = new FormData();
    formData.append("full_name", document.getElementById("editName").value);
    formData.append("email", document.getElementById("editEmail").value);

    const password = document.getElementById("editPassword").value;
    if (password && password.trim() !== "") formData.append("password", password);

    formData.append("address", document.getElementById("editAddress").value);
    formData.append("department", document.getElementById("editDept").value);
    formData.append("subject_to_teach", document.getElementById("editSubject").value);
    formData.append("available_time", document.getElementById("editTime").value);
    formData.append("available", document.getElementById("editAvailable").value); // fixed
    formData.append("whatsapp_number", document.getElementById("editWhatsapp").value);
    formData.append("about_me", document.getElementById("editAbout").value);
    formData.append("intro_video_link", document.getElementById("editVideo").value);

    const photoFile = document.getElementById("editPhoto").files[0];
    if (photoFile) formData.append("photo", photoFile);

    const idPhotoFile = document.getElementById("editIdPhoto").files[0];
    if (idPhotoFile) formData.append("id_photo", idPhotoFile);

    try {
      const response = await fetch(`${apiBase}/profiles/${user.id}`, {
        method: "PUT",
        body: formData
      });
      const data = await response.json();

      if (response.ok && data.success) {
        alert("Profile updated successfully!");

        if (data.user) {
          const updatedUser = {
            id: data.user.id,
            full_name: data.user.full_name,
            email: data.user.email,
            address: data.user.address,
            department: data.user.department,
            subject_to_teach: data.user.subject_to_teach,
            photo: data.user.photo,
            whatsapp_number: data.user.whatsapp_number,
            id_photo: data.user.id_photo,
            about_me: data.user.about_me,
            intro_video_link: data.user.intro_video_link,
            available_time: data.user.available_time,
            available: data.user.available
          };
          localStorage.setItem("loggedInUser", JSON.stringify(updatedUser));
        }

        window.location.href = "/myprofile.html";
      } else {
        const msg = data && data.message ? data.message : "Failed to update profile.";
        alert(msg);
      }
    } catch (err) {
      console.error("Update failed:", err);
      alert("Failed to update profile (network or server error).");
    }
  };

  // Delete profile permanently
  document.getElementById("deleteBtn").onclick = async () => {
    if (!user || !user.id) return alert("User info missing.");
    if (!confirm("If you delete everything will be lost permanently! Are you sure?")) return;
    try {
      const response = await fetch(`${apiBase}/profiles/${user.id}`, { method: "DELETE" });
      const data = await response.json();
      if (response.ok && data.success) {
        alert("Profile deleted permanently!");
        localStorage.removeItem("loggedInUser");
        window.location.href = "/index.html";
      } else {
        alert(data && data.message ? data.message : "Failed to delete profile.");
      }
    } catch (err) {
      console.error("Delete failed:", err);
      alert("Failed to delete profile (network or server error).");
    }
  };
</script>

</body>
</html>